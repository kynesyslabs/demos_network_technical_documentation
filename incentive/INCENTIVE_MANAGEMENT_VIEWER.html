<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incentive Management - Interactive Diagram Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .navigation {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            justify-content: center;
        }

        .nav-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .nav-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .content {
            padding: 40px;
        }

        .diagram-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .diagram-section.active {
            display: block;
        }

        .diagram-section h2 {
            color: #2d3748;
            font-size: 2em;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .diagram-section p {
            color: #4a5568;
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            border: 1px solid #e2e8f0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .key-points {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 30px 0;
            border-radius: 4px;
        }

        .key-points h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .key-points ul {
            list-style-position: inside;
            color: #4a5568;
            line-height: 1.8;
        }

        .key-points li {
            margin: 8px 0;
        }

        footer {
            background: #2d3748;
            color: white;
            text-align: center;
            padding: 30px;
            font-size: 0.95em;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .navigation {
                padding: 20px;
            }

            .nav-btn {
                padding: 10px 16px;
                font-size: 0.85em;
            }

            .content {
                padding: 20px;
            }

            .diagram-section h2 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Incentive Management</h1>
            <p>Comprehensive Diagram Viewer - Point Systems & Referral Mechanics</p>
        </header>

        <nav class="navigation">
            <button class="nav-btn active" onclick="showDiagram(1)">1. Architecture</button>
            <button class="nav-btn" onclick="showDiagram(2)">2. Class Structure</button>
            <button class="nav-btn" onclick="showDiagram(3)">3. Data Model</button>
            <button class="nav-btn" onclick="showDiagram(4)">4. Award Points</button>
            <button class="nav-btn" onclick="showDiagram(5)">5. Deduct Points</button>
            <button class="nav-btn" onclick="showDiagram(6)">6. Referral Code</button>
            <button class="nav-btn" onclick="showDiagram(7)">7. Referral Flow</button>
            <button class="nav-btn" onclick="showDiagram(8)">8. Validation</button>
            <button class="nav-btn" onclick="showDiagram(9)">9. GCR Integration</button>
            <button class="nav-btn" onclick="showDiagram(10)">10. Complete Lifecycle</button>
        </nav>

        <div class="content">
            <!-- Diagram 1: Architecture Overview -->
            <section id="diagram-1" class="diagram-section active">
                <h2>1. Incentive Architecture Overview</h2>
                <p>
                    This diagram shows the complete architecture of the Incentive Management system, including the PointSystem singleton,
                    Referrals static class, point value configurations, GCR integration for identity management, and external service integrations.
                </p>
                <div class="mermaid">
graph TB
    subgraph "Incentive Management System"
        PS[PointSystem Singleton]
        REF[Referrals Static Class]
        PV[Point Values Config]
    end

    subgraph "Point Values"
        WEB3[LINK_WEB3_WALLET: 0.5]
        TWITTER[LINK_TWITTER: 2]
        GITHUB[LINK_GITHUB: 1]
        TELEGRAM[LINK_TELEGRAM: 1]
        DISCORD[LINK_DISCORD: 1]
        FOLLOW[FOLLOW_DEMOS: 1]
    end

    subgraph "Referral System"
        REFBONUS[REFERRER_BONUS: 2 pts]
        USERBONUS[REFERRED_USER_BONUS: 1 pt]
        CODEGEN[Referral Code Generator]
    end

    subgraph "GCR Integration"
        GCRMain[(GCRMain Entity)]
        Points[points.totalPoints]
        Breakdown[points.breakdown]
        ReferralInfo[referralInfo]
        Identities[identities.xm & web2]
    end

    subgraph "Identity Management"
        IM[IdentityManager]
        XMID[XM Chain Identities]
        WEB2ID[Web2 Identities]
    end

    subgraph "External Services"
        TwitterAPI[Twitter API]
        TelegramAttest[Telegram Attestation]
        GithubAPI[Github API]
        DiscordAPI[Discord API]
    end

    PS --> PV
    PS --> GCRMain
    PS --> IM
    REF --> GCRMain
    REF --> CODEGEN

    PV --> WEB3
    PV --> TWITTER
    PV --> GITHUB
    PV --> TELEGRAM
    PV --> DISCORD
    PV --> FOLLOW

    GCRMain --> Points
    GCRMain --> Breakdown
    GCRMain --> ReferralInfo
    GCRMain --> Identities

    IM --> XMID
    IM --> WEB2ID

    Breakdown --> |web3Wallets| XMID
    Breakdown --> |socialAccounts| WEB2ID
    Breakdown --> |referrals| ReferralInfo
    Breakdown --> |demosFollow| TwitterAPI

    PS --> TwitterAPI
    PS --> TelegramAttest
    PS --> GithubAPI
    PS --> DiscordAPI

    style PS fill:#e1f5ff
    style REF fill:#fff4e1
    style GCRMain fill:#e8f5e9
    style IM fill:#f3e5f5
                </div>
                <div class="key-points">
                    <h3>Key Architectural Components</h3>
                    <ul>
                        <li><strong>PointSystem</strong>: Singleton pattern managing all point operations (award/deduct)</li>
                        <li><strong>Referrals</strong>: Static utility class for referral code generation and processing</li>
                        <li><strong>Point Values</strong>: Web3 (0.5), Twitter (2), GitHub (1), Telegram (1), Discord (1), Follow (1)</li>
                        <li><strong>Referral Bonuses</strong>: Referrer gets 2 points, referred user gets 1 point</li>
                        <li><strong>GCR Integration</strong>: PostgreSQL with GCRMain entity storing points, identities, referral data</li>
                        <li><strong>Identity Management</strong>: XM chain wallets (ETH, BSC, Solana, Aptos) + Web2 socials</li>
                        <li><strong>External Services</strong>: Twitter API for follow checks, Telegram attestation for group membership</li>
                    </ul>
                </div>
            </section>

            <!-- Diagram 2: Class Structure -->
            <section id="diagram-2" class="diagram-section">
                <h2>2. Point System Class Structure</h2>
                <p>
                    This class diagram illustrates the TypeScript class structure for PointSystem (singleton with award/deduct methods),
                    Referrals (static class with code generation), UserPoints (response type), and IdentityManager (GCR queries).
                </p>
                <div class="mermaid">
classDiagram
    class PointSystem {
        -static instance: PointSystem
        -constructor()
        +static getInstance() PointSystem
        -getUserIdentitiesFromGCR(userId: string) Promise~Identities~
        -getUserPointsInternal(userId: string) Promise~UserPoints~
        -addPointsToGCR(userId, points, type, platform) Promise~void~
        +getUserPoints(userId: string) Promise~RPCResponse~
        +awardWeb3WalletPoints(userId, walletAddress, chain, referralCode?) Promise~RPCResponse~
        +awardTwitterPoints(userId, twitterUserId, referralCode?) Promise~RPCResponse~
        +awardGithubPoints(userId, githubUserId, referralCode?) Promise~RPCResponse~
        +awardTelegramPoints(userId, telegramUserId, referralCode?, attestation?) Promise~RPCResponse~
        +awardDiscordPoints(userId, referralCode?) Promise~RPCResponse~
        +deductWeb3WalletPoints(userId, walletAddress, chain) Promise~RPCResponse~
        +deductTwitterPoints(userId) Promise~RPCResponse~
        +deductGithubPoints(userId, githubUserId) Promise~RPCResponse~
        +deductTelegramPoints(userId) Promise~RPCResponse~
        +deductDiscordPoints(userId) Promise~RPCResponse~
    }

    class Referrals {
        +static readonly REFERRER_BONUS: 2
        +static readonly REFERRED_USER_BONUS: 1
        -static calculateBytesForLength(targetLength: number) number
        -static generateChecksum(publicKey: string) string
        +static generateReferralCode(publicKey, options?) string
        +static findAccountByReferralCode(referralCode) Promise~GCRMain~
        +static isAlreadyReferred(referrerAccount, newUserPubkey) boolean
        +static isEligibleForReferral(account) boolean
        +static processReferral(newAccount, referralCode, repository) Promise~void~
        -static awardReferralPoints(referrerAccount, newUserAccount, repository) Promise~void~
    }

    class UserPoints {
        +string userId
        +string referralCode
        +number totalPoints
        +Breakdown breakdown
        +string[] linkedWallets
        +LinkedSocials linkedSocials
        +Date lastUpdated
        +any flagged
        +string flaggedReason
    }

    class Breakdown {
        +object web3Wallets
        +SocialAccounts socialAccounts
        +number referrals
        +number demosFollow
    }

    class SocialAccounts {
        +number twitter
        +number github
        +number telegram
        +number discord
    }

    class LinkedSocials {
        +string twitter
        +string discord
    }

    class IdentityManager {
        +static getIdentities(userId) Promise~XMIdentities~
        +static getWeb2Identities(userId, platform) Promise~Web2Identity[]~
    }

    PointSystem --> Referrals : uses
    PointSystem --> UserPoints : returns
    PointSystem --> IdentityManager : queries
    UserPoints --> Breakdown : contains
    Breakdown --> SocialAccounts : contains

    note for PointSystem "Singleton pattern\nManages all point operations"
    note for Referrals "Static utility class\nHandles referral mechanics"
    note for UserPoints "Complete user profile\nwith points and identities"
                </div>
                <div class="key-points">
                    <h3>Class Structure Details</h3>
                    <ul>
                        <li><strong>PointSystem Singleton</strong>: getInstance() ensures single instance, prevents direct construction</li>
                        <li><strong>Public Award Methods</strong>: Platform-specific (Web3, Twitter, GitHub, Telegram, Discord)</li>
                        <li><strong>Public Deduct Methods</strong>: Mirror award methods for account unlinking</li>
                        <li><strong>Private Helper Methods</strong>: getUserIdentitiesFromGCR, getUserPointsInternal, addPointsToGCR</li>
                        <li><strong>Referrals Static Class</strong>: No instance needed, pure utility functions</li>
                        <li><strong>UserPoints Response</strong>: Complete profile with totalPoints, breakdown, identities, referral code</li>
                        <li><strong>Breakdown Structure</strong>: web3Wallets (object), socialAccounts (object), referrals (number), demosFollow (number)</li>
                    </ul>
                </div>
            </section>

            <!-- Diagram 3: Data Model -->
            <section id="diagram-3" class="diagram-section">
                <h2>3. User Points Data Model</h2>
                <p>
                    This entity-relationship diagram shows the complete GCRMain data model with JSONB fields for points, breakdown,
                    referralInfo, and identities, demonstrating the PostgreSQL storage structure for incentive data.
                </p>
                <div class="mermaid">
erDiagram
    GCRMain {
        TEXT pubkey PK
        JSONB points
        JSONB referralInfo
        JSONB identities
        BOOLEAN flagged
        TEXT flaggedReason
    }

    Points {
        NUMBER totalPoints
        JSONB breakdown
        TIMESTAMP lastUpdated
    }

    Breakdown {
        JSONB web3Wallets
        JSONB socialAccounts
        NUMBER referrals
        NUMBER demosFollow
    }

    Web3Wallets {
        NUMBER eth
        NUMBER bsc
        NUMBER polygon
        NUMBER solana
        NUMBER aptos
        TEXT additional_chains
    }

    SocialAccounts {
        NUMBER twitter
        NUMBER github
        NUMBER telegram
        NUMBER discord
    }

    ReferralInfo {
        NUMBER totalReferrals
        TEXT referralCode
        JSONB referrals
        TEXT referredBy
    }

    Referral {
        TEXT referredUserId
        TEXT referredAt
        NUMBER pointsAwarded
    }

    Identities {
        JSONB xm
        JSONB web2
    }

    XMIdentities {
        JSONB eth
        JSONB bsc
        JSONB solana
        JSONB aptos
        TEXT additional_chains
    }

    Web2Identities {
        ARRAY twitter
        ARRAY github
        ARRAY telegram
        ARRAY discord
    }

    GCRMain ||--|| Points : "has points"
    GCRMain ||--|| ReferralInfo : "has referralInfo"
    GCRMain ||--|| Identities : "has identities"
    Points ||--|| Breakdown : "contains breakdown"
    Breakdown ||--|| Web3Wallets : "web3Wallets by chain"
    Breakdown ||--|| SocialAccounts : "socialAccounts by platform"
    ReferralInfo ||--o{ Referral : "contains referrals array"
    Identities ||--|| XMIdentities : "xm chain identities"
    Identities ||--|| Web2Identities : "web2 social identities"
                </div>
                <div class="key-points">
                    <h3>Data Model Features</h3>
                    <ul>
                        <li><strong>GCRMain Entity</strong>: Primary key is pubkey (ed25519 public key as hex string)</li>
                        <li><strong>Points JSONB</strong>: Flexible structure with totalPoints, breakdown, lastUpdated</li>
                        <li><strong>Breakdown Structure</strong>: Separate tracking for web3Wallets (by chain), socialAccounts (by platform)</li>
                        <li><strong>ReferralInfo</strong>: totalReferrals count, unique referralCode, referrals array, referredBy pubkey</li>
                        <li><strong>Identities</strong>: xm (multi-chain wallets), web2 (social accounts)</li>
                        <li><strong>Flagging System</strong>: Boolean flagged field with text reason for anti-abuse</li>
                        <li><strong>Referral Array</strong>: Each referral stores referredUserId, referredAt timestamp, pointsAwarded</li>
                    </ul>
                </div>
            </section>

            <!-- Diagram 4: Award Points Flow -->
            <section id="diagram-4" class="diagram-section">
                <h2>4. Award Points Flow</h2>
                <p>
                    This sequence diagram demonstrates the complete award points flow for Web3 wallets (with Twitter requirement),
                    Twitter (with follow bonus), Telegram (with group attestation), and GitHub/Discord, including referral processing.
                </p>
                <div class="mermaid">
sequenceDiagram
    participant User
    participant RPC as RPC Handler
    participant PS as PointSystem
    participant IM as IdentityManager
    participant GCR as GCRMain Repository
    participant Twitter as Twitter API
    participant Telegram as Telegram Attestation
    participant Ref as Referrals

    rect rgb(200, 220, 240)
        Note over User,Ref: Award Web3 Wallet Points Flow
        User->>RPC: Link wallet (chain, address, referralCode?)
        RPC->>PS: awardWeb3WalletPoints(userId, address, chain, referralCode)
        PS->>PS: getUserPointsInternal(userId)
        PS->>IM: getIdentities(userId)
        IM-->>PS: Return XM chain identities
        PS->>PS: Check if Twitter linked (required)
        alt No Twitter linked
            PS-->>RPC: 400 "Twitter account not linked"
        end
        PS->>PS: Check if wallet already linked
        PS->>PS: Check if chain wallet already exists
        PS->>PS: addPointsToGCR(userId, 0.5, "web3Wallets", chain, referralCode)
        PS->>GCR: Load account from database
        GCR-->>PS: Return GCRMain account
        PS->>Ref: isEligibleForReferral(account)
        Ref-->>PS: Eligibility result
        alt Eligible and has referral code
            PS->>Ref: processReferral(account, referralCode, repository)
            Ref->>Ref: Award referrer 2 pts, new user 1 pt
        end
        PS->>GCR: Save updated account
        PS->>PS: getUserPointsInternal(userId)
        PS-->>RPC: Return updated points
        RPC-->>User: 200 OK with points
    end

    rect rgb(220, 240, 200)
        Note over User,Ref: Award Twitter Points Flow
        User->>RPC: Link Twitter (twitterUserId, referralCode?)
        RPC->>PS: awardTwitterPoints(userId, twitterUserId, referralCode)
        PS->>PS: getUserPointsInternal(userId)
        PS->>PS: Check if Twitter points already awarded
        alt Already awarded
            PS-->>RPC: 200 "Twitter points already awarded"
        end
        PS->>PS: addPointsToGCR(userId, 2, "socialAccounts", "twitter", referralCode, twitterUserId)
        PS->>Twitter: checkFollow(twitterUsername)
        Twitter-->>PS: isFollowingDemos
        alt Following Demos
            PS->>PS: Add 1 bonus point for FOLLOW_DEMOS
        end
        PS->>Ref: Process referral if eligible
        PS->>GCR: Save account
        PS-->>RPC: 200 OK with 2 points awarded
    end

    rect rgb(240, 220, 200)
        Note over User,Ref: Award Telegram Points Flow
        User->>RPC: Link Telegram (telegramUserId, referralCode?, attestation)
        RPC->>PS: awardTelegramPoints(userId, telegramUserId, referralCode, attestation)
        PS->>GCR: ensureGCRForUser(userId)
        PS->>PS: Verify Telegram ownership
        alt Not owner
            PS-->>RPC: 400 "Telegram account not linked"
        end
        PS->>PS: Check if Telegram points already awarded
        PS->>Telegram: Check group_membership from attestation
        alt Not in required group
            PS-->>RPC: 200 "Must join group to earn points"
        end
        PS->>PS: addPointsToGCR(userId, 1, "socialAccounts", "telegram", referralCode)
        PS->>Ref: Process referral if eligible
        PS->>GCR: Save account
        PS-->>RPC: 200 OK with 1 point awarded
    end

    rect rgb(240, 240, 200)
        Note over User,GCR: Award GitHub/Discord Points Flow
        User->>RPC: Link GitHub/Discord
        RPC->>PS: awardGithubPoints() / awardDiscordPoints()
        PS->>GCR: Verify account ownership
        PS->>PS: Check if points already awarded
        PS->>PS: addPointsToGCR(userId, 1, "socialAccounts", platform, referralCode)
        PS->>Ref: Process referral if eligible
        PS->>GCR: Save account
        PS-->>RPC: 200 OK with 1 point awarded
    end
                </div>
                <div class="key-points">
                    <h3>Award Points Process</h3>
                    <ul>
                        <li><strong>Web3 Wallet</strong>: Requires Twitter linked first, checks for duplicates, one wallet per chain</li>
                        <li><strong>Twitter</strong>: 2 points awarded, checks for @Demos follow (+1 bonus), enables Web3 linking</li>
                        <li><strong>Telegram</strong>: Requires group_membership in attestation payload, ownership verification</li>
                        <li><strong>GitHub/Discord</strong>: 1 point each, ownership verification from GCR identities</li>
                        <li><strong>Referral Processing</strong>: Automatic if eligible, awards 2 pts to referrer, 1 pt to new user</li>
                        <li><strong>Eligibility Checks</strong>: No prior referredBy, no existing referrals, no existing points</li>
                    </ul>
                </div>
            </section>

            <!-- Diagram 5: Deduct Points Flow -->
            <section id="diagram-5" class="diagram-section">
                <h2>5. Deduct Points Flow</h2>
                <p>
                    This flowchart shows the complete deduction flow for unlinking accounts, including special handling for Twitter
                    (removes follow bonus), checking for existing points before deduction, and updating the breakdown structure.
                </p>
                <div class="mermaid">
flowchart TD
    Start([Unlink Account Request]) --> CheckType{Account Type?}

    CheckType -->|Web3 Wallet| Web3Flow[Web3 Wallet Deduction]
    CheckType -->|Twitter| TwitterFlow[Twitter Deduction]
    CheckType -->|GitHub| GitHubFlow[GitHub Deduction]
    CheckType -->|Telegram| TelegramFlow[Telegram Deduction]
    CheckType -->|Discord| DiscordFlow[Discord Deduction]

    Web3Flow --> GetUserPoints1[Get user points]
    GetUserPoints1 --> DeductWeb3[addPointsToGCR -0.5 points]
    DeductWeb3 --> UpdateChainPoints[Update web3Wallets breakdown]
    UpdateChainPoints --> SaveWeb3[Save to GCRMain]
    SaveWeb3 --> ReturnWeb3[Return updated totalPoints]
    ReturnWeb3 --> Success([Operation Complete])

    TwitterFlow --> GetUserPoints2[Get user points]
    GetUserPoints2 --> CheckTwitterPoints{Current Twitter points > 0?}
    CheckTwitterPoints -->|No| NoTwitterPoints[Return 0 points deducted]
    CheckTwitterPoints -->|Yes| DeductTwitter[addPointsToGCR -2 points]
    DeductTwitter --> DeductFollowBonus{Has FOLLOW_DEMOS bonus?}
    DeductFollowBonus -->|Yes| RemoveFollowBonus[Deduct -1 FOLLOW_DEMOS]
    DeductFollowBonus -->|No| SaveTwitter[Save to GCRMain]
    RemoveFollowBonus --> SaveTwitter
    SaveTwitter --> ReturnTwitter[Return -2 or -3 points deducted]
    ReturnTwitter --> Success
    NoTwitterPoints --> Success

    GitHubFlow --> GetUserPoints3[Get user points]
    GetUserPoints3 --> CheckGitHubPoints{Current GitHub points > 0?}
    CheckGitHubPoints -->|No| NoGitHubPoints[Return 0 points deducted]
    CheckGitHubPoints -->|Yes| DeductGitHub[addPointsToGCR -1 point]
    DeductGitHub --> SaveGitHub[Save to GCRMain]
    SaveGitHub --> ReturnGitHub[Return -1 point deducted]
    ReturnGitHub --> Success
    NoGitHubPoints --> Success

    TelegramFlow --> GetUserPoints4[Get user points]
    GetUserPoints4 --> CheckTelegramPoints{Current Telegram points > 0?}
    CheckTelegramPoints -->|No| NoTelegramPoints[Return 0 points deducted]
    CheckTelegramPoints -->|Yes| DeductTelegram[addPointsToGCR -1 point]
    DeductTelegram --> SaveTelegram[Save to GCRMain]
    SaveTelegram --> ReturnTelegram[Return -1 point deducted]
    ReturnTelegram --> Success
    NoTelegramPoints --> Success

    DiscordFlow --> GetUserPoints5[Get user points]
    GetUserPoints5 --> CheckDiscordPoints{Current Discord points > 0?}
    CheckDiscordPoints -->|No| NoDiscordPoints[Return 0 points deducted]
    CheckDiscordPoints -->|Yes| DeductDiscord[addPointsToGCR -1 point]
    DeductDiscord --> SaveDiscord[Save to GCRMain]
    SaveDiscord --> ReturnDiscord[Return -1 point deducted]
    ReturnDiscord --> Success
    NoDiscordPoints --> Success

    style Start fill:#e1f5ff
    style Success fill:#c8e6c9
    style CheckType fill:#fff9c4
    style CheckTwitterPoints fill:#fff9c4
    style CheckGitHubPoints fill:#fff9c4
    style CheckTelegramPoints fill:#fff9c4
    style CheckDiscordPoints fill:#fff9c4
    style DeductFollowBonus fill:#ffecb3
                </div>
                <div class="key-points">
                    <h3>Deduction Process</h3>
                    <ul>
                        <li><strong>Web3 Wallet</strong>: Deduct 0.5 points, update web3Wallets breakdown for specific chain</li>
                        <li><strong>Twitter</strong>: Check for existing points first, deduct 2 points, remove follow bonus if present</li>
                        <li><strong>GitHub/Telegram/Discord</strong>: Check for existing points, deduct 1 point each</li>
                        <li><strong>Zero Balance Handling</strong>: Return 0 points deducted if platform has no points</li>
                        <li><strong>Breakdown Update</strong>: Deduct from both totalPoints and platform-specific breakdown</li>
                        <li><strong>Follow Bonus</strong>: Twitter unlinking may deduct up to 3 points (2 + 1 follow bonus)</li>
                    </ul>
                </div>
            </section>

            <!-- Diagram 6: Referral Code Generation -->
            <section id="diagram-6" class="diagram-section">
                <h2>6. Referral Code Generation</h2>
                <p>
                    This flowchart demonstrates the collision-resistant referral code generation algorithm using ed25519 public keys,
                    SHA256 hashing, Base58 encoding, and optional checksum validation for human-friendly, deterministic codes.
                </p>
                <div class="mermaid">
flowchart TD
    Start([Generate Referral Code]) --> Input[Input: ed25519 public key 0x...]
    Input --> ValidateKey{Valid 64 hex chars?}
    ValidateKey -->|No| Error([Throw Invalid Key Error])
    ValidateKey -->|Yes| CleanKey[Remove 0x prefix]

    CleanKey --> HashKey[SHA256 hash of clean key]
    HashKey --> CalcBytes[Calculate bytes for length]

    CalcBytes --> BytesMap{Target Length?}
    BytesMap -->|8 chars| Use8Bytes[Use 8 bytes ~56 bits]
    BytesMap -->|10 chars| Use9Bytes[Use 9 bytes ~63 bits]
    BytesMap -->|12 chars| Use10Bytes[Use 10 bytes ~70 bits]
    BytesMap -->|16 chars| Use14Bytes[Use 14 bytes ~98 bits]

    Use8Bytes --> ExtractBytes[Extract bytes from hash]
    Use9Bytes --> ExtractBytes
    Use10Bytes --> ExtractBytes
    Use14Bytes --> ExtractBytes

    ExtractBytes --> EncodeBase58[Encode with Base58]
    EncodeBase58 --> TruncateLength[Truncate to exact length]

    TruncateLength --> CheckChecksum{Include Checksum?}
    CheckChecksum -->|No| AddPrefix[Add optional prefix]
    CheckChecksum -->|Yes| GenChecksum[Generate 2-char checksum]

    GenChecksum --> ChecksumFlow[SHA256 of key + CHECKSUM]
    ChecksumFlow --> EncodeChecksum[Base58 encode checksum]
    EncodeChecksum --> ReplaceLastTwo[Replace last 2 chars with checksum]
    ReplaceLastTwo --> AddPrefix

    AddPrefix --> Return([Return Referral Code])

    style Start fill:#e1f5ff
    style Return fill:#c8e6c9
    style Error fill:#ffcdd2
    style ValidateKey fill:#fff9c4
    style BytesMap fill:#fff9c4
    style CheckChecksum fill:#fff9c4
    style EncodeBase58 fill:#e8f5e9
    style GenChecksum fill:#f3e5f5

    Note1[Example Code: 12 chars\n10 bytes SHA256\nBase58 encoded\nCollision-resistant]
    Note1 -.-> Return

    Note2[Properties:\n- Human-friendly Base58\n- No ambiguous chars 0,O,I,l\n- Deterministic from pubkey\n- Optional validation checksum]
    Note2 -.-> EncodeBase58
                </div>
                <div class="key-points">
                    <h3>Referral Code Properties</h3>
                    <ul>
                        <li><strong>Deterministic</strong>: Same public key always generates same referral code</li>
                        <li><strong>Collision-Resistant</strong>: SHA256 + Base58 ensures uniqueness across 2^256 space</li>
                        <li><strong>Human-Friendly</strong>: Base58 alphabet excludes ambiguous characters (0, O, I, l)</li>
                        <li><strong>Configurable Length</strong>: 8, 10, 12, or 16 characters with appropriate entropy</li>
                        <li><strong>Optional Checksum</strong>: 2-character validation checksum for typo detection</li>
                        <li><strong>Default Config</strong>: 12 characters (70 bits entropy) without checksum</li>
                    </ul>
                </div>
            </section>

            <!-- Diagram 7: Referral Processing Flow -->
            <section id="diagram-7" class="diagram-section">
                <h2>7. Referral Processing Flow</h2>
                <p>
                    This sequence diagram shows the complete referral processing flow from eligibility checks (no prior referrals,
                    no existing points) through validation (no self-referral, no duplicates) to awarding bonuses to both parties.
                </p>
                <div class="mermaid">
sequenceDiagram
    participant NewUser as New User
    participant PS as PointSystem
    participant Ref as Referrals
    participant GCR as GCRMain Repository
    participant Referrer as Referrer Account

    rect rgb(200, 220, 240)
        Note over NewUser,Referrer: Referral Processing Flow
        NewUser->>PS: Award points with referralCode
        PS->>Ref: isEligibleForReferral(newUserAccount)

        Ref->>Ref: Check if already has referredBy
        alt Already referred
            Ref-->>PS: Not eligible (has referredBy)
        end

        Ref->>Ref: Check if has existing referrals
        alt Has referrals
            Ref-->>PS: Not eligible (has referrals)
        end

        Ref->>Ref: Check if totalReferrals > 0
        alt Has total referrals
            Ref-->>PS: Not eligible (totalReferrals > 0)
        end

        Ref->>Ref: Check if totalPoints > 0 before current award
        alt Has existing points
            Ref-->>PS: Not eligible (has points)
        end

        Ref-->>PS: Eligible for referral
    end

    rect rgb(220, 240, 200)
        Note over PS,Referrer: Process Valid Referral
        PS->>Ref: processReferral(newUserAccount, referralCode, repository)
        Ref->>GCR: findAccountByReferralCode(referralCode)
        GCR-->>Ref: Return referrer account or null

        alt Referral code not found
            Ref-->>PS: Invalid code, return
        end

        Ref->>Ref: Check if self-referral
        alt Referrer == New User
            Ref-->>PS: Self-referral blocked, return
        end

        Ref->>Ref: isAlreadyReferred(referrer, newUserPubkey)
        alt Already referred by this referrer
            Ref-->>PS: Duplicate referral, return
        end

        Ref->>Ref: awardReferralPoints(referrer, newUser, repository)
    end

    rect rgb(240, 220, 200)
        Note over Ref,Referrer: Award Points to Both Parties
        Ref->>Referrer: Add REFERRER_BONUS (2 pts) to totalPoints
        Ref->>Referrer: Add 2 pts to breakdown.referrals
        Ref->>Referrer: Increment totalReferrals count
        Ref->>Referrer: Push referral to referrals array
        Ref->>Referrer: Update lastUpdated timestamp

        Ref->>NewUser: Set referredBy = referrer.pubkey
        Ref->>NewUser: Add REFERRED_USER_BONUS (1 pt) to totalPoints
        Ref->>NewUser: Add 1 pt to breakdown.referrals
        Ref->>NewUser: Update lastUpdated timestamp

        Ref->>GCR: Save referrer account
        GCR-->>Ref: Saved (auto-saves new user in parent flow)

        Ref-->>PS: Referral processed successfully
    end

    rect rgb(240, 240, 200)
        Note over NewUser,PS: Return to Original Flow
        PS->>GCR: Save new user account with referral bonus
        PS-->>NewUser: Return points with referral bonus included
    end
                </div>
                <div class="key-points">
                    <h3>Referral Processing Details</h3>
                    <ul>
                        <li><strong>Eligibility Checks</strong>: No referredBy, no existing referrals, totalReferrals == 0, totalPoints == 0</li>
                        <li><strong>Validation Checks</strong>: Valid referral code, no self-referral, no duplicate referrals</li>
                        <li><strong>Referrer Bonus</strong>: +2 points to totalPoints and breakdown.referrals</li>
                        <li><strong>New User Bonus</strong>: +1 point to totalPoints and breakdown.referrals</li>
                        <li><strong>Referral Tracking</strong>: referrals array stores referredUserId, referredAt, pointsAwarded</li>
                        <li><strong>Two-Way Link</strong>: Referrer has new user in referrals[], new user has referredBy = referrer.pubkey</li>
                    </ul>
                </div>
            </section>

            <!-- Diagram 8: Eligibility & Validation Rules -->
            <section id="diagram-8" class="diagram-section">
                <h2>8. Eligibility & Validation Rules</h2>
                <p>
                    This comprehensive state machine shows all validation layers from Twitter requirements and duplicate checks
                    through ownership verification, Telegram group attestation, and complex referral eligibility rules with multiple blocking conditions.
                </p>
                <div class="mermaid">
stateDiagram-v2
    [*] --> ValidateRequest: Award Points Request

    state ValidateRequest {
        [*] --> CheckTwitterRequired
        CheckTwitterRequired --> TwitterLinked: Web3 wallet award?
        TwitterLinked --> CheckDuplicates: Yes, Twitter linked
        CheckTwitterRequired --> CheckDuplicates: Other awards
        TwitterLinked --> [*]: No Twitter linked (reject)
    }

    ValidateRequest --> CheckDuplicates: Validation passed

    state CheckDuplicates {
        [*] --> CheckWalletDuplicate
        CheckWalletDuplicate --> WalletAlreadyLinked: Web3 wallet?
        WalletAlreadyLinked --> [*]: Already linked (reject)
        CheckWalletDuplicate --> CheckChainLimit: Not linked

        CheckChainLimit --> ChainLimitExceeded: Has wallet on chain?
        ChainLimitExceeded --> [*]: Chain limit reached (reject)
        CheckChainLimit --> CheckSocialDuplicate: No wallet on chain

        CheckSocialDuplicate --> SocialAlreadyAwarded: Social account?
        SocialAlreadyAwarded --> [*]: Points already awarded (reject)
        CheckSocialDuplicate --> CheckOwnership: Not awarded yet
    }

    CheckDuplicates --> CheckOwnership: No duplicates

    state CheckOwnership {
        [*] --> VerifyGitHub
        VerifyGitHub --> GitHubVerified: GitHub award?
        GitHubVerified --> CheckTelegramAttest: Verified
        VerifyGitHub --> CheckTelegramAttest: Other awards
        GitHubVerified --> [*]: Not verified (reject)

        CheckTelegramAttest --> TelegramGroupCheck: Telegram award?
        TelegramGroupCheck --> GroupMembershipValid: Check attestation
        GroupMembershipValid --> CheckDiscord: Member of group
        TelegramGroupCheck --> [*]: Not in group (no points)
        CheckTelegramAttest --> CheckDiscord: Other awards

        CheckDiscord --> DiscordVerified: Discord award?
        DiscordVerified --> EligibilityCheck: Verified
        CheckDiscord --> EligibilityCheck: Other awards
        DiscordVerified --> [*]: Not verified (reject)
    }

    CheckOwnership --> EligibilityCheck: Ownership verified

    state EligibilityCheck {
        [*] --> HasReferralCode
        HasReferralCode --> CheckEligibility: Yes, has code
        HasReferralCode --> AwardPoints: No code

        CheckEligibility --> CheckReferredBy: Check eligibility
        CheckReferredBy --> NotEligible1: Has referredBy
        CheckReferredBy --> CheckExistingReferrals: No referredBy

        CheckExistingReferrals --> NotEligible2: Has referrals[]
        CheckExistingReferrals --> CheckTotalReferrals: No referrals

        CheckTotalReferrals --> NotEligible3: totalReferrals > 0
        CheckTotalReferrals --> CheckExistingPoints: totalReferrals == 0

        CheckExistingPoints --> NotEligible4: totalPoints > 0
        CheckExistingPoints --> ProcessReferral: totalPoints == 0

        NotEligible1 --> AwardPoints: Skip referral
        NotEligible2 --> AwardPoints: Skip referral
        NotEligible3 --> AwardPoints: Skip referral
        NotEligible4 --> AwardPoints: Skip referral

        ProcessReferral --> ValidateReferralCode: Eligible
        ValidateReferralCode --> InvalidCode: Code not found
        ValidateReferralCode --> CheckSelfReferral: Valid code

        InvalidCode --> AwardPoints: Skip referral

        CheckSelfReferral --> SelfReferral: Same pubkey?
        SelfReferral --> AwardPoints: Skip self-referral
        CheckSelfReferral --> CheckDuplicateReferral: Different user

        CheckDuplicateReferral --> DuplicateReferral: Already in referrals[]?
        DuplicateReferral --> AwardPoints: Skip duplicate
        CheckDuplicateReferral --> AwardReferralBonus: Not duplicate

        AwardReferralBonus --> AwardPoints: +1 pt for user, +2 pts for referrer
    }

    EligibilityCheck --> AwardPoints: Validation complete

    AwardPoints --> UpdateGCR: Add points to totalPoints
    UpdateGCR --> UpdateBreakdown: Update breakdown
    UpdateBreakdown --> CheckDemosFollow: Twitter award?
    CheckDemosFollow --> QueryTwitterAPI: Check follow status
    QueryTwitterAPI --> AddFollowBonus: Following @Demos
    QueryTwitterAPI --> SaveToDatabase: Not following
    AddFollowBonus --> SaveToDatabase: +1 bonus point
    CheckDemosFollow --> SaveToDatabase: Other awards
    SaveToDatabase --> [*]: Points awarded

    note right of ValidateRequest
        First validation layer
        Platform-specific requirements
    end note

    note right of CheckDuplicates
        Prevent duplicate awards
        One wallet per chain rule
    end note

    note right of CheckOwnership
        Verify account ownership
        Telegram group membership
    end note

    note right of EligibilityCheck
        Complex referral eligibility
        Multiple blocking conditions
    end note
                </div>
                <div class="key-points">
                    <h3>Validation Rules</h3>
                    <ul>
                        <li><strong>Twitter Requirement</strong>: Web3 wallet linking requires Twitter account linked first</li>
                        <li><strong>One Wallet Per Chain</strong>: Cannot link multiple wallets of same chain type (ETH, BSC, etc.)</li>
                        <li><strong>Duplicate Prevention</strong>: Check if wallet already linked or social points already awarded</li>
                        <li><strong>Ownership Verification</strong>: GitHub and Discord require matching userId in GCR identities</li>
                        <li><strong>Telegram Group Attestation</strong>: group_membership must be true in attestation payload</li>
                        <li><strong>Referral Eligibility</strong>: Must have no referredBy, no referrals, no totalReferrals, no points</li>
                        <li><strong>Anti-Gaming</strong>: Self-referral blocked, duplicate referrals blocked by referrals array check</li>
                    </ul>
                </div>
            </section>

            <!-- Diagram 9: GCR Integration -->
            <section id="diagram-9" class="diagram-section">
                <h2>9. GCR Integration & Identity Management</h2>
                <p>
                    This sequence diagram shows the complete GCR integration flow for identity queries (XM chains and Web2 platforms),
                    account creation/initialization, Twitter follow status checks, and the getUserPointsInternal aggregation.
                </p>
                <div class="mermaid">
sequenceDiagram
    participant PS as PointSystem
    participant IM as IdentityManager
    participant EG as ensureGCRForUser
    participant GCR as GCRMain Repository
    participant DB as PostgreSQL Database
    participant Twitter as Twitter API

    rect rgb(200, 220, 240)
        Note over PS,DB: Get User Identities from GCR
        PS->>IM: getIdentities(userId)
        IM->>GCR: Query GCRMain by pubkey
        GCR->>DB: SELECT identities.xm FROM GCRMain
        DB-->>GCR: Return XM identities JSON
        GCR-->>IM: Return xm chain identities

        IM->>IM: Parse XM chain structure
        loop For each chain (eth, bsc, solana, aptos)
            IM->>IM: Extract subchain identities
            IM->>IM: Build wallet array: chain:address
        end
        IM-->>PS: Return linkedWallets[] array
    end

    rect rgb(220, 240, 200)
        Note over PS,DB: Get Web2 Identities from GCR
        PS->>IM: getWeb2Identities(userId, "twitter")
        IM->>GCR: Query GCRMain by pubkey
        GCR->>DB: SELECT identities.web2.twitter FROM GCRMain
        DB-->>GCR: Return Twitter identities array
        GCR-->>IM: Return twitter identities
        IM-->>PS: Return [{userId, username}]

        PS->>IM: getWeb2Identities(userId, "discord")
        IM->>GCR: Query GCRMain by pubkey
        GCR->>DB: SELECT identities.web2.discord FROM GCRMain
        DB-->>GCR: Return Discord identities array
        GCR-->>IM: Return discord identities
        IM-->>PS: Return [{userId, username}]
    end

    rect rgb(240, 220, 200)
        Note over PS,DB: Ensure GCR Account Exists
        PS->>EG: ensureGCRForUser(userId)
        EG->>GCR: findOneBy({pubkey: userId})
        GCR->>DB: SELECT * FROM GCRMain WHERE pubkey = ?
        DB-->>GCR: Return account or null

        alt Account exists
            GCR-->>EG: Return existing account
        else Account does not exist
            EG->>GCR: HandleGCR.createAccount(userId)
            GCR->>DB: INSERT INTO GCRMain (pubkey, points, referralInfo, identities)
            DB-->>GCR: New account created
            GCR-->>EG: Return new account
        end

        EG->>EG: Check if referralInfo exists
        alt Missing referralInfo
            EG->>EG: Initialize referralInfo with generated code
            EG->>GCR: save(account)
        end

        EG-->>PS: Return account with referralInfo
    end

    rect rgb(240, 240, 200)
        Note over PS,Twitter: Check Twitter Follow Status
        PS->>GCR: Load user account
        GCR-->>PS: Return account with web2.twitter identities
        PS->>PS: Find Twitter identity by twitterUserId

        alt Has Twitter identity
            PS->>Twitter: checkFollow(twitterUsername)
            Twitter->>Twitter: Query Twitter API for follow relationship
            Twitter-->>PS: Return isFollowingDemos boolean

            alt Following @Demos
                PS->>PS: Add 1 point to breakdown.demosFollow
                PS->>PS: Add 1 point to totalPoints
                PS->>GCR: save(account)
            end
        end
    end

    rect rgb(200, 240, 240)
        Note over PS,DB: Complete getUserPointsInternal Flow
        PS->>GCR: findOneBy({pubkey: userId})
        GCR->>DB: SELECT * FROM GCRMain
        DB-->>GCR: Return account

        alt Account not found
            PS->>GCR: HandleGCR.createAccount(userId)
        end

        PS->>IM: Get XM and Web2 identities
        PS->>PS: Build UserPoints response object
        PS->>PS: Include totalPoints, breakdown, linkedWallets, linkedSocials
        PS->>PS: Include referralCode, lastUpdated, flagged status
        PS-->>PS: Return complete UserPoints object
    end
                </div>
                <div class="key-points">
                    <h3>GCR Integration Details</h3>
                    <ul>
                        <li><strong>Identity Queries</strong>: IdentityManager provides abstraction for XM chain and Web2 identity access</li>
                        <li><strong>XM Identities</strong>: Nested structure eth/bsc/solana/aptos with subchain arrays</li>
                        <li><strong>Web2 Identities</strong>: Platform-specific queries (twitter, github, telegram, discord)</li>
                        <li><strong>Auto-Creation</strong>: ensureGCRForUser creates account if not found with initialized fields</li>
                        <li><strong>Referral Code Generation</strong>: Generated on first account creation or when missing</li>
                        <li><strong>Twitter Follow Check</strong>: Live API query to detect @Demos follow for bonus point</li>
                        <li><strong>UserPoints Aggregation</strong>: Complete profile built from GCRMain + IdentityManager queries</li>
                    </ul>
                </div>
            </section>

            <!-- Diagram 10: Complete Lifecycle -->
            <section id="diagram-10" class="diagram-section">
                <h2>10. Complete Incentive Lifecycle</h2>
                <p>
                    This comprehensive state machine shows the complete incentive lifecycle from system initialization through user registration,
                    account linking, point awards/deductions, referral operations, flagging, and graceful shutdown.
                </p>
                <div class="mermaid">
stateDiagram-v2
    [*] --> SystemInit: Initialize Incentive System

    SystemInit --> GetSingleton: Get PointSystem instance
    GetSingleton --> InitializeGCR: Initialize GCR connection
    InitializeGCR --> SystemReady: System ready for operations

    SystemReady --> NewUserRegistration: New user registers
    SystemReady --> ExistingUserOperation: Existing user operation

    state NewUserRegistration {
        [*] --> EnsureGCR: Ensure GCR account
        EnsureGCR --> GenerateReferralCode: Generate referral code
        GenerateReferralCode --> InitializePoints: Initialize points = 0
        InitializePoints --> InitializeBreakdown: Initialize breakdown structure
        InitializeBreakdown --> InitializeReferralInfo: Initialize referralInfo
        InitializeReferralInfo --> SaveNewAccount: Save to GCRMain
        SaveNewAccount --> [*]
    }

    NewUserRegistration --> ReadyForLinking: Account created

    state ExistingUserOperation {
        [*] --> LoadAccount: Load GCRMain account
        LoadAccount --> CheckOperation: Determine operation
    }

    ExistingUserOperation --> ReadyForLinking: Account loaded

    state ReadyForLinking {
        [*] --> ChooseLinkType
        ChooseLinkType --> LinkWeb3: Link Web3 wallet
        ChooseLinkType --> LinkTwitter: Link Twitter
        ChooseLinkType --> LinkGitHub: Link GitHub
        ChooseLinkType --> LinkTelegram: Link Telegram
        ChooseLinkType --> LinkDiscord: Link Discord
    }

    ReadyForLinking --> AwardPointsFlow: Link account

    state AwardPointsFlow {
        [*] --> ValidateRequest
        ValidateRequest --> CheckTwitterReq: Web3 wallet?
        CheckTwitterReq --> TwitterRequired: Require Twitter first
        TwitterRequired --> [*]: Reject if no Twitter
        CheckTwitterReq --> CheckDuplicates: Has Twitter or other platform

        CheckDuplicates --> DuplicateDetected: Already linked?
        DuplicateDetected --> [*]: Reject duplicate
        CheckDuplicates --> CheckOwnership: No duplicate

        CheckOwnership --> OwnershipFailed: Not owner?
        OwnershipFailed --> [*]: Reject non-owner
        CheckOwnership --> CheckAttestation: Ownership verified

        CheckAttestation --> TelegramAttest: Telegram?
        TelegramAttest --> GroupNotMember: Not in group?
        GroupNotMember --> [*]: No points awarded
        TelegramAttest --> AddPoints: In group
        CheckAttestation --> AddPoints: Other platforms

        AddPoints --> UpdateTotalPoints: Add platform points
        UpdateTotalPoints --> UpdateBreakdown: Update breakdown
        UpdateBreakdown --> CheckReferral: Has referral code?

        CheckReferral --> ProcessReferralFlow: Yes, check eligibility
        CheckReferral --> CheckFollowBonus: No referral code

        ProcessReferralFlow --> ReferralProcessed: Award referral bonus
        ReferralProcessed --> CheckFollowBonus: +1 pt user, +2 pts referrer

        CheckFollowBonus --> TwitterFollowCheck: Twitter link?
        TwitterFollowCheck --> QueryTwitterAPI: Check follow status
        QueryTwitterAPI --> FollowingDemos: Following @Demos?
        FollowingDemos --> AddFollowBonus: Add 1 bonus point
        FollowingDemos --> SaveAccount: Not following
        TwitterFollowCheck --> SaveAccount: Other platforms
        AddFollowBonus --> SaveAccount: demosFollow bonus

        SaveAccount --> ReturnResponse: Save to GCRMain
        ReturnResponse --> [*]: Return RPCResponse
    }

    AwardPointsFlow --> AccountUpdated: Points awarded

    AccountUpdated --> QueryPoints: User queries points
    AccountUpdated --> UnlinkAccount: User unlinks account
    AccountUpdated --> ReadyForLinking: Link more accounts

    state QueryPoints {
        [*] --> GetUserPointsInternal
        GetUserPointsInternal --> LoadFromGCR: Load account
        LoadFromGCR --> GetIdentities: Get XM + Web2 identities
        GetIdentities --> BuildResponse: Build UserPoints object
        BuildResponse --> ReturnUserPoints: Return complete profile
        ReturnUserPoints --> [*]
    }

    QueryPoints --> AccountUpdated: Points returned

    state UnlinkAccount {
        [*] --> ChooseUnlinkType
        ChooseUnlinkType --> UnlinkWeb3: Unlink wallet
        ChooseUnlinkType --> UnlinkTwitter: Unlink Twitter
        ChooseUnlinkType --> UnlinkGitHub: Unlink GitHub
        ChooseUnlinkType --> UnlinkTelegram: Unlink Telegram
        ChooseUnlinkType --> UnlinkDiscord: Unlink Discord

        UnlinkWeb3 --> DeductWeb3Points: Deduct 0.5 points
        UnlinkTwitter --> DeductTwitterPoints: Deduct 2 points
        UnlinkGitHub --> DeductGitHubPoints: Deduct 1 point
        UnlinkTelegram --> DeductTelegramPoints: Deduct 1 point
        UnlinkDiscord --> DeductDiscordPoints: Deduct 1 point

        DeductWeb3Points --> UpdateAfterDeduct
        DeductTwitterPoints --> CheckFollowDeduct: Remove follow bonus?
        CheckFollowDeduct --> DeductFollowBonus: Yes, deduct 1 more
        CheckFollowDeduct --> UpdateAfterDeduct: No follow bonus
        DeductFollowBonus --> UpdateAfterDeduct: Total -3 points
        DeductGitHubPoints --> UpdateAfterDeduct
        DeductTelegramPoints --> UpdateAfterDeduct
        DeductDiscordPoints --> UpdateAfterDeduct

        UpdateAfterDeduct --> SaveDeduction: Update breakdown & total
        SaveDeduction --> ReturnDeduction: Save to GCRMain
        ReturnDeduction --> [*]: Return updated points
    }

    UnlinkAccount --> AccountUpdated: Points deducted

    state ReferralOperations {
        [*] --> GenerateCode: Generate referral code
        GenerateCode --> ShareCode: Share with friends
        ShareCode --> WaitForReferral: Wait for referral
        WaitForReferral --> ReferralTriggered: New user uses code
        ReferralTriggered --> CheckEligibility: Validate eligibility
        CheckEligibility --> NotEligible: Failed checks
        NotEligible --> [*]: Skip referral
        CheckEligibility --> AwardBothParties: Eligible
        AwardBothParties --> Referrer2Points: Referrer +2 pts
        AwardBothParties --> NewUser1Point: New user +1 pt
        Referrer2Points --> UpdateReferralInfo: Update referral lists
        NewUser1Point --> UpdateReferralInfo
        UpdateReferralInfo --> SaveBothAccounts: Save both accounts
        SaveBothAccounts --> [*]: Referral complete
    }

    AccountUpdated --> ReferralOperations: User shares referral code
    ReferralOperations --> AccountUpdated: Referral processed

    AccountUpdated --> FlagAccount: Suspicious activity detected

    state FlagAccount {
        [*] --> DetectSuspicious
        DetectSuspicious --> SetFlaggedTrue: Set flagged = true
        SetFlaggedTrue --> SetFlaggedReason: Set flaggedReason
        SetFlaggedReason --> SaveFlagged: Save to GCRMain
        SaveFlagged --> BlockOperations: Block future point operations
        BlockOperations --> [*]
    }

    FlagAccount --> SystemShutdown: Account flagged

    AccountUpdated --> SystemShutdown: Graceful shutdown
    QueryPoints --> SystemShutdown: Shutdown requested
    ReadyForLinking --> SystemShutdown: Shutdown requested

    SystemShutdown --> CloseConnections: Close GCR connections
    CloseConnections --> [*]: System stopped

    note right of SystemInit
        Initialize PointSystem singleton
        Connect to GCR database
    end note

    note right of NewUserRegistration
        First-time user setup
        Generate referral code
        Initialize all fields
    end note

    note right of AwardPointsFlow
        Multi-stage validation
        Platform-specific rules
        Referral processing
        Bonus calculations
    end note

    note right of ReferralOperations
        Two-party point award
        Eligibility checks
        Anti-gaming measures
    end note

    note right of FlagAccount
        Anti-abuse mechanism
        Suspicious pattern detection
    end note
                </div>
                <div class="key-points">
                    <h3>Complete Lifecycle Overview</h3>
                    <ul>
                        <li><strong>Initialization</strong>: PointSystem singleton  GCR connection  ready for operations</li>
                        <li><strong>User Registration</strong>: Create account  generate referral code  initialize points/breakdown</li>
                        <li><strong>Account Linking</strong>: Choose platform  validate  award points  process referral  check bonuses</li>
                        <li><strong>Point Query</strong>: Load from GCR  get identities  build complete UserPoints response</li>
                        <li><strong>Account Unlinking</strong>: Choose platform  check existing points  deduct  update breakdown</li>
                        <li><strong>Referral Operations</strong>: Generate code  share  validate eligibility  award both parties</li>
                        <li><strong>Flagging System</strong>: Detect suspicious activity  set flagged = true  block operations</li>
                        <li><strong>Shutdown</strong>: Close GCR connections  graceful exit</li>
                    </ul>
                </div>
            </section>
        </div>

        <footer>
            <p><strong>Incentive Management</strong> - Comprehensive Diagram Documentation</p>
            <p>10 Detailed Mermaid Diagrams Covering Point Systems, Referral Mechanics, GCR Integration, and Anti-Gaming Measures</p>
            <p>Files: PointSystem.ts | referrals.ts</p>
        </footer>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                wrap: true,
                width: 150
            },
            stateDiagram: {
                useMaxWidth: true
            },
            er: {
                useMaxWidth: true
            },
            class: {
                useMaxWidth: true
            }
        });

        function showDiagram(num) {
            // Hide all sections
            const sections = document.querySelectorAll('.diagram-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected section
            document.getElementById('diagram-' + num).classList.add('active');

            // Add active class to clicked button
            event.target.classList.add('active');

            // Scroll to top of content
            document.querySelector('.content').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
